<!DOCTYPE HTML>
<html lang="zh-CN" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>跨程序调用Cross-Program Invocations - The Anchor Book v0.23.0 中文版</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../chapter_1/introduction.html"><strong aria-hidden="true">1.</strong> 引言</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chapter_1/what_is_anchor.html"><strong aria-hidden="true">1.1.</strong> 什么是Anchor</a></li><li class="chapter-item expanded "><a href="../chapter_1/anchor_documentation.html"><strong aria-hidden="true">1.2.</strong> Anchor文档</a></li><li class="chapter-item expanded "><a href="../chapter_1/prerequisites.html"><strong aria-hidden="true">1.3.</strong> 必要基础</a></li></ol></li><li class="chapter-item expanded "><a href="../chapter_2/getting_started.html"><strong aria-hidden="true">2.</strong> 入门</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chapter_2/installation.html"><strong aria-hidden="true">2.1.</strong> 安装</a></li><li class="chapter-item expanded "><a href="../chapter_2/hello_anchor.html"><strong aria-hidden="true">2.2.</strong> Hello, Anchor!</a></li></ol></li><li class="chapter-item expanded "><a href="../chapter_3/anchor_programs_in-depth.html"><strong aria-hidden="true">3.</strong> 深入了解Anchor程序</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chapter_3/essentials.html"><strong aria-hidden="true">3.1.</strong> 核心内容</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chapter_3/high-level_overview.html"><strong aria-hidden="true">3.1.1.</strong> 总览</a></li><li class="chapter-item expanded "><a href="../chapter_3/the_accounts_struct.html"><strong aria-hidden="true">3.1.2.</strong> The Accounts Struct</a></li><li class="chapter-item expanded "><a href="../chapter_3/the_program_module.html"><strong aria-hidden="true">3.1.3.</strong> The Program Module</a></li><li class="chapter-item expanded "><a href="../chapter_3/errors.html"><strong aria-hidden="true">3.1.4.</strong> Errors</a></li><li class="chapter-item expanded "><a href="../chapter_3/milestone_project_tic-tac-toe.html"><strong aria-hidden="true">3.1.5.</strong> 里程碑项目 - Tic-Tac-Toe</a></li></ol></li><li class="chapter-item expanded "><a href="../chapter_3/intermediate.html"><strong aria-hidden="true">3.2.</strong> 进阶内容</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chapter_3/CPIs.html" class="active"><strong aria-hidden="true">3.2.1.</strong> 跨程序调用Cross-Program Invocations</a></li><li class="chapter-item expanded "><a href="../chapter_3/PDAs.html"><strong aria-hidden="true">3.2.2.</strong> 程序导出地址PDAs</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.3.</strong> 事件Events</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.4.</strong> 常量Constants</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.5.</strong> 零复制Zero-Copy</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.6.</strong> 权限控制Access Control</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.7.</strong> 构建和测试Building &amp; Testing</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.8.</strong> 里程碑项目 - The Nightclub</div></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Anchor BTS</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.1.</strong> Dispatch</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.</strong> The Discriminator</div></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../chapter_5/anchor_tooling.html"><strong aria-hidden="true">5.</strong> Anchor相关工具</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chapter_5/space.html"><strong aria-hidden="true">5.1.</strong> 数据所占空间</a></li><li class="chapter-item expanded "><a href="../chapter_5/cli.html"><strong aria-hidden="true">5.2.</strong> 命令行CLI</a></li><li class="chapter-item expanded "><a href="../chapter_5/avm.html"><strong aria-hidden="true">5.3.</strong> Anchor版本管理器AVM</a></li><li class="chapter-item expanded "><a href="../chapter_5/anchor-toml_reference.html"><strong aria-hidden="true">5.4.</strong> Anchor.toml配置文件</a></li></ol></li><li class="chapter-item expanded "><a href="../reference_links.html"><strong aria-hidden="true">6.</strong> 参考链接</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Anchor Book v0.23.0 中文版</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="cross-program-invocations跨程序调用"><a class="header" href="#cross-program-invocations跨程序调用">Cross-Program Invocations跨程序调用</a></h1>
<p>我们经常需要在一个程序中调用另外一个程序。在Solana里，这是通过跨程序调用实现的（CPIs）。</p>
<p>来看一下这个傀儡大师操控傀儡的例子。当然，这不是一个非常实际的例子，但是足够说明一些CPIs中需要注意的细节。在这章最后的里程碑项目会有一个更接近实际场景的有很多CPIs调用的例子。</p>
<h2 id="搭建基础的cpi功能"><a class="header" href="#搭建基础的cpi功能">搭建基础的CPI功能</a></h2>
<p>创建一个新的workspace</p>
<pre><code>anchor init puppet
</code></pre>
<p>然后复制下面的代码：</p>
<pre><code class="language-rust ignore">use anchor_lang::prelude::*;

declare_id!(&quot;Fg6PaFpoGXkYsidMpWTK6W2BeZ7FEfcYkg476zPFsLnS&quot;);

#[program]
pub mod puppet {
    use super::*;
    pub fn initialize(_ctx: Context&lt;Initialize&gt;) -&gt; Result&lt;()&gt; {
        Ok(())
    }

    pub fn set_data(ctx: Context&lt;SetData&gt;, data: u64) -&gt; Result&lt;()&gt; {
        let puppet = &amp;mut ctx.accounts.puppet;
        puppet.data = data;
        Ok(())
    }
}

#[derive(Accounts)]
pub struct Initialize&lt;'info&gt; {
    #[account(init, payer = user, space = 8 + 8)]
    pub puppet: Account&lt;'info, Data&gt;,
    #[account(mut)]
    pub user: Signer&lt;'info&gt;,
    pub system_program: Program&lt;'info, System&gt;,
}

#[derive(Accounts)]
pub struct SetData&lt;'info&gt; {
    #[account(mut)]
    pub puppet: Account&lt;'info, Data&gt;,
}

#[account]
pub struct Data {
    pub data: u64,
}
</code></pre>
<p>上面的代码并没什么特别的地方，只是一个非常简单的程序！有意思的地方是它将怎么和我们接下来要创建的程序交互。（通过跨程序调用，也就是CPI）</p>
<p>在Workspace中运行</p>
<pre><code>anchor new puppet-master
</code></pre>
<p>inside the workspace and copy the following code:</p>
<pre><code class="language-rust ignore">use anchor_lang::prelude::*;
use puppet::cpi::accounts::SetData;
use puppet::program::Puppet;
use puppet::{self, Data};

declare_id!(&quot;HmbTLCmaGvZhKnn1Zfa1JVnp7vkMV4DYVxPLWBVoN65L&quot;);

#[program]
mod puppet_master {
    use super::*;
    pub fn pull_strings(ctx: Context&lt;PullStrings&gt;, data: u64) -&gt; Result&lt;()&gt; {
        let cpi_program = ctx.accounts.puppet_program.to_account_info();
        let cpi_accounts = SetData {
            puppet: ctx.accounts.puppet.to_account_info(),
        };
        let cpi_ctx = CpiContext::new(cpi_program, cpi_accounts);
        puppet::cpi::set_data(cpi_ctx, data)
    }
}

#[derive(Accounts)]
pub struct PullStrings&lt;'info&gt; {
    #[account(mut)]
    pub puppet: Account&lt;'info, Data&gt;,
    pub puppet_program: Program&lt;'info, Puppet&gt;,
}
</code></pre>
<p>然后加这行代码 <code>puppet_master = &quot;HmbTLCmaGvZhKnn1Zfa1JVnp7vkMV4DYVxPLWBVoN65L&quot;</code> 到你<code>Anchor.toml</code>文件的<code>[programs.localnet]</code>部分。 最后, 引入puppet program到puppet-master program，这需要在<code>puppet-master</code> 程序文件夹中的<code>Cargo.toml</code> 文件里，要把下面的代码加到<code>[dependencies]</code>部分:</p>
<pre><code class="language-toml">puppet = { path = &quot;../puppet&quot;, features = [&quot;cpi&quot;]}
</code></pre>
<p><code>features = [&quot;cpi&quot;]</code>的配置是为了让我们不仅能够使用puppet的类，还能使用puppet的instruction builders还有cpi函数。 如果没有这些，我们就不得不用更低抽象层的solana syscalls。幸好anchor提供了这些接口的抽象，用起来会容易的多。 开启<code>cpi</code>功能之后, puppet-master程序就可以access到<code>puppet::cpi</code>模块。 Anchor 自动生成这个模块并且包含了专门的instructions builders还有对应的cpi helpers函数。</p>
<p>对于puppet程序, puppet-master使用<code>puppet::cpi::accounts</code> 模块提供的<code>SetData</code> instruction builder struct来提交puppet程序期望的<code>SetData</code> instruction的accounts. 然后，puppet-master创建一个新的cpi context 并把它传入<code>puppet::cpi::set_data</code>cpi函数。 这个函数的功能和puppet program中的<code>set_data</code> function完全一样，只是这里的要传的context是<code>CpiContext</code>而不是<code>Context</code>。</p>
<p>初始化CPI的代码和可能会分散业务逻辑代码的可读性，所以推荐的做法是把它放到instruction的<code>impl</code>代码。puppet-master程序会是这个样子:</p>
<pre><code class="language-rust ignore">use anchor_lang::prelude::*;
use puppet::cpi::accounts::SetData;
use puppet::program::Puppet;
use puppet::{self, Data};

declare_id!(&quot;HmbTLCmaGvZhKnn1Zfa1JVnp7vkMV4DYVxPLWBVoN65L&quot;);

#[program]
mod puppet_master {
    use super::*;
    pub fn pull_strings(ctx: Context&lt;PullStrings&gt;, data: u64) -&gt; Result&lt;()&gt; {
        puppet::cpi::set_data(ctx.accounts.set_data_ctx(), data)
    }
}

#[derive(Accounts)]
pub struct PullStrings&lt;'info&gt; {
    #[account(mut)]
    pub puppet: Account&lt;'info, Data&gt;,
    pub puppet_program: Program&lt;'info, Puppet&gt;,
}

impl&lt;'info&gt; PullStrings&lt;'info&gt; {
    pub fn set_data_ctx(&amp;self) -&gt; CpiContext&lt;'_, '_, '_, 'info, SetData&lt;'info&gt;&gt; {
        let cpi_program = self.puppet_program.to_account_info();
        let cpi_accounts = SetData {
            puppet: self.puppet.to_account_info()
        };
        CpiContext::new(cpi_program, cpi_accounts)
    }
}
</code></pre>
<p>我们可以验证有所得步骤都按预期可以运行，这秩序把<code>puppet.ts</code>文件得内容换成如下:</p>
<pre><code class="language-ts">import * as anchor from '@project-serum/anchor';
import { Program } from '@project-serum/anchor';
import { Keypair, SystemProgram } from '@solana/web3.js';
import { expect } from 'chai';
import { Puppet } from '../target/types/puppet';
import { PuppetMaster } from '../target/types/puppet_master';

describe('puppet', () =&gt; {
  anchor.setProvider(anchor.Provider.env());

  const puppetProgram = anchor.workspace.Puppet as Program&lt;Puppet&gt;;
  const puppetMasterProgram = anchor.workspace.PuppetMaster as Program&lt;PuppetMaster&gt;;

  const puppetKeypair = Keypair.generate();

  it('Does CPI!', async () =&gt; {
    await puppetProgram.rpc.initialize({
      accounts: {
        puppet: puppetKeypair.publicKey,
        user: anchor.getProvider().wallet.publicKey,
        systemProgram: SystemProgram.programId
      },
      signers: [puppetKeypair]
    });

    await puppetMasterProgram.rpc.pullStrings(new anchor.BN(42),{
      accounts: {
        puppetProgram: puppetProgram.programId,
        puppet: puppetKeypair.publicKey
      }
    })

    expect((await puppetProgram.account.data
      .fetch(puppetKeypair.publicKey)).data.toNumber()).to.equal(42);
  });
});
</code></pre>
<p>然后运行<code>anchor test</code>.</p>
<h2 id="privilege-extension权限得延伸性"><a class="header" href="#privilege-extension权限得延伸性">Privilege Extension权限得延伸性</a></h2>
<p>CPIs 会把权限由调用者延续给被调用的程序. puppet account是传给puppet-master的mutable account但它对于通过CPI调用的puppet程序依然是mutable的(否则测试中的<code>expect</code>会报错). 这同样是适用于用户签名(signatures).</p>
<p>如果你想验证这一点，可以在puppet程序加个<code>authority</code>字段给<code>Data</code>struct.</p>
<pre><code class="language-rust ignore">#[account]
pub struct Data {
    pub data: u64,
    pub authority: Pubkey
}
</code></pre>
<p>然后调整<code>initialize</code>函数:</p>
<pre><code class="language-rust ignore">pub fn initialize(ctx: Context&lt;Initialize&gt;, authority: Pubkey) -&gt; Result&lt;()&gt; {
    ctx.accounts.puppet.authority = authority;
    Ok(())
}
</code></pre>
<p>加<code>32</code>给<code>puppet</code>的<code>space</code> constraint因为<code>Data</code> struct新加了<code>Pubkey</code>字段。</p>
<pre><code class="language-rust ignore">#[derive(Accounts)]
pub struct Initialize&lt;'info&gt; {
    #[account(init, payer = user, space = 8 + 8 + 32)]
    pub puppet: Account&lt;'info, Data&gt;,
    #[account(mut)]
    pub user: Signer&lt;'info&gt;,
    pub system_program: Program&lt;'info, System&gt;,
}
</code></pre>
<p>然后, 调整<code>SetData</code>的validation struct:</p>
<pre><code class="language-rust ignore">#[derive(Accounts)]
pub struct SetData&lt;'info&gt; {
    #[account(mut, has_one = authority)]
    pub puppet: Account&lt;'info, Data&gt;,
    pub authority: Signer&lt;'info&gt;
}
</code></pre>
<p><code>has_one</code>这个限制条件检查<code>puppet.authority = authority.key()</code>.</p>
<p>puppet-master程序现在也需要调整:</p>
<pre><code class="language-rust ignore">use anchor_lang::prelude::*;
use puppet::cpi::accounts::SetData;
use puppet::program::Puppet;
use puppet::{self, Data};

declare_id!(&quot;HmbTLCmaGvZhKnn1Zfa1JVnp7vkMV4DYVxPLWBVoN65L&quot;);

#[program]
mod puppet_master {
    use super::*;
    pub fn pull_strings(ctx: Context&lt;PullStrings&gt;, data: u64) -&gt; Result&lt;()&gt; {
        puppet::cpi::set_data(ctx.accounts.set_data_ctx(), data)
    }
}

#[derive(Accounts)]
pub struct PullStrings&lt;'info&gt; {
    #[account(mut)]
    pub puppet: Account&lt;'info, Data&gt;,
    pub puppet_program: Program&lt;'info, Puppet&gt;,
    // Even though the puppet program already checks that authority is a signer
    // using the Signer type here is still required because the anchor ts client
    // can not infer signers from programs called via CPIs
    pub authority: Signer&lt;'info&gt;
}

impl&lt;'info&gt; PullStrings&lt;'info&gt; {
    pub fn set_data_ctx(&amp;self) -&gt; CpiContext&lt;'_, '_, '_, 'info, SetData&lt;'info&gt;&gt; {
        let cpi_program = self.puppet_program.to_account_info();
        let cpi_accounts = SetData {
            puppet: self.puppet.to_account_info(),
            authority: self.authority.to_account_info()
        };
        CpiContext::new(cpi_program, cpi_accounts)
    }
}
</code></pre>
<p>最后, 改一下test:</p>
<pre><code class="language-ts">import * as anchor from '@project-serum/anchor';
import { Program } from '@project-serum/anchor';
import { Keypair, SystemProgram } from '@solana/web3.js';
import { Puppet } from '../target/types/puppet';
import { PuppetMaster } from '../target/types/puppet_master';
import { expect } from 'chai';

describe('puppet', () =&gt; {
  anchor.setProvider(anchor.Provider.env());

  const puppetProgram = anchor.workspace.Puppet as Program&lt;Puppet&gt;;
  const puppetMasterProgram = anchor.workspace.PuppetMaster as Program&lt;PuppetMaster&gt;;

  const puppetKeypair = Keypair.generate();
  const authorityKeypair = Keypair.generate();

  it('Does CPI!', async () =&gt; {
    await puppetProgram.rpc.initialize(authorityKeypair.publicKey, {
      accounts: {
        puppet: puppetKeypair.publicKey,
        user: anchor.getProvider().wallet.publicKey,
        systemProgram: SystemProgram.programId,
      },
      signers: [puppetKeypair]
    });

    await puppetMasterProgram.rpc.pullStrings(new anchor.BN(42),{
      accounts: {
        puppetProgram: puppetProgram.programId,
        puppet: puppetKeypair.publicKey,
        authority: authorityKeypair.publicKey
      },
      signers: [authorityKeypair]
    })

    expect((await puppetProgram.account.data
      .fetch(puppetKeypair.publicKey)).data.toNumber()).to.equal(42);
  });
});
</code></pre>
<p>测试通过了，这是因为传给puppet-master的signature权限会被延申到puppet program，而puppet程序用signature来确认puppet account确实对交易进行了签名。</p>
<blockquote>
<p>Privilege extension特权延申算然很方便但是也很危险。如果一个对恶意程序的CPI被无意中调用了，就很危险了。
因为这个程序的调用中程序和调用者的权限一样，相当于你给了恶意程序权限。
Anchor 有两个办法可以保护你无意中调用恶意程序的CPIs：
首先, <code>Program&lt;'info, T&gt;</code> 类型会检查所提供的account是应该传入的正确的程序<code>T</code>。
如果你忘了用<code>Program</code>类型, 自动生成的cpi function
(比如上个例子中的<code>puppet::cpi::set_data</code>)
也会检查<code>cpi_program</code>的传入参数是应该传入的正确的程序。</p>
</blockquote>
<h2 id="重新加载一个account"><a class="header" href="#重新加载一个account">重新加载一个Account</a></h2>
<p>在puppet程序中, <code>Account&lt;'info, T&gt;</code> 类型被用来表示<code>puppet</code> account. 如果通过CPI更改了一个该类型的account，那么在调用程序（caller）中的这个account在调用之后是不会变化的。</p>
<p>你可以很容易自己验证这一点，可以把下面的代码加到<code>puppet::cpi::set_data(ctx.accounts.set_data_ctx(), data)</code> CPI调用之后。</p>
<pre><code class="language-rust ignore">puppet::cpi::set_data(ctx.accounts.set_data_ctx(), data)?;
if ctx.accounts.puppet.data != 42 {
    panic!();
}
Ok(())
</code></pre>
<p>现在你的测试会失败。为啥呢？之前的测试是可以跑通的，所以CPI确实把<code>data</code>字段更新为<code>42</code>了。</p>
<p><code>data</code>字段没有在调用函数中更新的原因是，只有在instruction开始被处理的时候<code>Account&lt;'info, T&gt;</code>类型会反序列化输入的字节为一个新的struct。在这之后，这个struct就不再会随着链上account的数据更新而更新了。CPI更改了链上的account，但是因为调用程序中的struct和链上的account并没有联系，所以调用程序中的struct并不发生变化。</p>
<p>如果你需要读最新的刚刚被CPI更新过的account的状态，你可以调用<code>reload</code>方法，这样会重新反序列化account。如果你把<code>ctx.accounts.puppet.reload()?;</code>加到CPI调用之后，测试就可以通过了。</p>
<pre><code class="language-rust ignore">puppet::cpi::set_data(ctx.accounts.set_data_ctx(), data)?;
ctx.accounts.puppet.reload()?;
if ctx.accounts.puppet.data != 42 {
    panic!();
}
Ok(())
</code></pre>
<h2 id="如何从cpi返回值"><a class="header" href="#如何从cpi返回值">如何从CPI返回值</a></h2>
<p>在Solana 1.8.12之后, <code>set_return_data</code>和<code>get_return_data</code> syscalls可以被用来写和读CPIs的返回值。 虽然你已经可以在用Anchor的程序中直接使用这些接口, Anchor暂时还没有提供搭更好的抽象来简化。</p>
<p>syscalls的返回值最大只可以有1024字节，所以我们依然有必要介绍老的获取CPI返回值的方法，这样可以应付大于1024字节的情况。</p>
<p>通过共同使用CPI和<code>reload</code>我们可以模拟返回值的功能。比如，一个例子就是，我们可能没有直接给<code>data</code>字段赋值为42，而是对<code>42</code>进行了一些计算，然后把结果保存到了<code>data</code>字段。然后puppet-master就可以在CPI之后调用<code>reload</code>，来使用计算的结果，实现返回值的效果。</p>
<h2 id="programs-as-signers由程序来签名"><a class="header" href="#programs-as-signers由程序来签名">Programs as Signers由程序来签名</a></h2>
<p>还有另外一个功能可以通过CPIs实现。但是，要了解的话，我们必须先学习什么是PDAs (由程序导出的地址)。这些我们会在下一个章讲解。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../chapter_3/intermediate.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../chapter_3/PDAs.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../chapter_3/intermediate.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../chapter_3/PDAs.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
